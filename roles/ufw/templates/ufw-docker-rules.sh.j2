#!/bin/bash
# SPDX-License-Identifier: MIT-0
# UFW Docker integration script
# Configures DOCKER-USER chain to control external access to Docker containers
# Managed by Ansible - do not edit manually

set -e

# Use iptables-legacy if available (Docker uses legacy on some systems)
if command -v iptables-legacy >/dev/null 2>&1; then
    # Check if Docker is using legacy iptables
    if iptables-legacy -L DOCKER-USER -n >/dev/null 2>&1; then
        IPTABLES="iptables-legacy"
    else
        IPTABLES="iptables"
    fi
else
    IPTABLES="iptables"
fi

# Check if DOCKER-USER chain exists
if ! $IPTABLES -L DOCKER-USER -n >/dev/null 2>&1; then
    echo "DOCKER-USER chain not found. Docker may not be running."
    exit 0
fi

# Flush existing DOCKER-USER rules
$IPTABLES -F DOCKER-USER

# Allow established connections
$IPTABLES -A DOCKER-USER -m conntrack --ctstate ESTABLISHED,RELATED -j RETURN

{% for network in ufw_docker_private_networks %}
# Allow from private network {{ network }}
$IPTABLES -A DOCKER-USER -s {{ network }} -j RETURN

{% endfor %}
{% for port in ufw_docker_allowed_ports %}
# Allow port {{ port.port }}/{{ port.proto }} from anywhere
$IPTABLES -A DOCKER-USER -p {{ port.proto }} --dport {{ port.port }} -j RETURN

{% endfor %}
# Drop all other external traffic to Docker containers
$IPTABLES -A DOCKER-USER -j DROP

echo "DOCKER-USER chain configured successfully"
