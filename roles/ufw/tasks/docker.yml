#SPDX-License-Identifier: MIT-0
---
# Docker integration tasks for UFW
# Manages DOCKER-USER chain to control external access to Docker containers
# Uses systemd service to persist rules across Docker restarts

- name: Check if DOCKER-USER chain exists
  ansible.builtin.command: iptables -L DOCKER-USER -n
  register: ufw_docker_user_chain
  failed_when: false
  changed_when: false

- name: Warn if DOCKER-USER chain does not exist
  ansible.builtin.debug:
    msg: >
      DOCKER-USER chain not found. Docker may not be installed or running.
      Skipping Docker integration. Install Docker first, then re-run this role.
  when: ufw_docker_user_chain.rc != 0

- name: Configure DOCKER-USER chain
  when: ufw_docker_user_chain.rc == 0
  block:
    - name: Deploy DOCKER-USER rules script
      ansible.builtin.template:
        src: ufw-docker-rules.sh.j2
        dest: /usr/local/sbin/ufw-docker-rules.sh
        owner: root
        group: root
        mode: "0755"
      notify: Run ufw-docker-rules

    - name: Deploy ufw-docker systemd service
      ansible.builtin.template:
        src: ufw-docker.service.j2
        dest: /etc/systemd/system/ufw-docker.service
        owner: root
        group: root
        mode: "0644"
      notify:
        - Reload systemd
        - Restart ufw-docker

    - name: Enable ufw-docker service
      ansible.builtin.systemd:
        name: ufw-docker
        enabled: true
        daemon_reload: true

    - name: Run DOCKER-USER rules script now
      ansible.builtin.command: /usr/local/sbin/ufw-docker-rules.sh
      changed_when: true
