#SPDX-License-Identifier: MIT-0
---
# Docker integration tasks for UFW
# Manages DOCKER-USER chain to control external access to Docker containers

- name: Check if DOCKER-USER chain exists
  ansible.builtin.command: iptables -L DOCKER-USER -n
  register: ufw_docker_user_chain
  failed_when: false
  changed_when: false

- name: Warn if DOCKER-USER chain does not exist
  ansible.builtin.debug:
    msg: >
      DOCKER-USER chain not found. Docker may not be installed or running.
      Skipping Docker integration. Install Docker first, then re-run this role.
  when: ufw_docker_user_chain.rc != 0

- name: Configure DOCKER-USER chain
  when: ufw_docker_user_chain.rc == 0
  block:
    - name: Flush DOCKER-USER chain
      ansible.builtin.iptables:
        chain: DOCKER-USER
        flush: true

    - name: Allow established connections in DOCKER-USER
      ansible.builtin.iptables:
        chain: DOCKER-USER
        ctstate: ESTABLISHED,RELATED
        jump: RETURN
        comment: "Allow established connections"

    - name: Allow private networks in DOCKER-USER
      ansible.builtin.iptables:
        chain: DOCKER-USER
        source: "{{ item }}"
        jump: RETURN
        comment: "Allow from private network {{ item }}"
      loop: "{{ ufw_docker_private_networks }}"

    - name: Allow specified ports from anywhere in DOCKER-USER
      ansible.builtin.iptables:
        chain: DOCKER-USER
        protocol: "{{ item.proto }}"
        destination_port: "{{ item.port }}"
        jump: RETURN
        comment: "Allow port {{ item.port }}/{{ item.proto }} from anywhere"
      loop: "{{ ufw_docker_allowed_ports }}"

    - name: Drop all other external traffic in DOCKER-USER
      ansible.builtin.iptables:
        chain: DOCKER-USER
        jump: DROP
        comment: "Drop external traffic to non-allowed ports"

    - name: Ensure iptables-persistent is installed
      ansible.builtin.apt:
        name: iptables-persistent
        state: present
        update_cache: true
        cache_valid_time: 3600

    - name: Save iptables rules for persistence
      ansible.builtin.command: netfilter-persistent save
      changed_when: true
