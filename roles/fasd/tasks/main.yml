#SPDX-License-Identifier: MIT-0
---
# tasks file for roles/fasd

- name: Verify Debian-based system
  ansible.builtin.assert:
    that:
      - ansible_os_family == 'Debian'
    fail_msg: "This role only supports Debian-based systems (Debian, Ubuntu, Raspberry Pi OS)"
    quiet: true

- name: Ensure dependencies are installed
  ansible.builtin.apt:
    name: "{{ fasd_dependencies }}"
    state: present
    update_cache: true
    cache_valid_time: 3600

- name: Check if fasd is already installed
  ansible.builtin.stat:
    path: "{{ fasd_install_path }}/fasd"
  register: fasd_binary_stat

- name: Clone fasd repository
  ansible.builtin.git:
    repo: "{{ fasd_git_repo_url }}"
    dest: "{{ fasd_clone_dir }}"
    version: "{{ fasd_git_version }}"
  when: not fasd_binary_stat.stat.exists

- name: Build and install fasd
  ansible.builtin.command:
    cmd: make install
    chdir: "{{ fasd_clone_dir }}"
    creates: "{{ fasd_install_path }}/fasd"
  when: not fasd_binary_stat.stat.exists

- name: Ensure fasd is sourced in user shell config
  ansible.builtin.lineinfile:
    path: "/home/{{ item.name }}/.bashrc"
    regexp: '^eval "\$\(fasd --init auto\)"'
    line: 'eval "$(fasd --init auto)"'
    state: present
    create: true
    owner: "{{ item.name }}"
    group: "{{ item.name }}"
    mode: '0644'
  loop: "{{ fasd_users }}"
  loop_control:
    label: "{{ item.name }}"
  when:
    - fasd_configure_shell
    - fasd_users | length > 0

- name: Remove fasd installation directory
  ansible.builtin.file:
    path: "{{ fasd_clone_dir }}"
    state: absent
  when: fasd_cleanup_build_dir
