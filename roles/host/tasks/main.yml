#SPDX-License-Identifier: MIT-0
---
# tasks file for roles/host

- name: Verify Debian-based system
  ansible.builtin.assert:
    that:
      - ansible_os_family == 'Debian'
    fail_msg: "This role only supports Debian-based systems (Debian, Ubuntu, Raspberry Pi OS)"
    quiet: true

- name: Verify host_hostname is set
  ansible.builtin.assert:
    that:
      - host_hostname | length > 0
    fail_msg: "host_hostname must be defined and not empty"

- name: Set short hostname fact
  ansible.builtin.set_fact:
    _host_short: "{{ host_short_hostname | default(host_hostname.split('.')[0]) }}"

- name: Set the hostname
  ansible.builtin.hostname:
    name: "{{ host_hostname }}"

# Per Debian convention, 127.0.1.1 maps to the machine's hostname
# while 127.0.0.1 is reserved for 'localhost'
- name: Update /etc/hosts with hostname
  ansible.builtin.lineinfile:
    path: /etc/hosts
    regexp: '^127\.0\.1\.1.*'
    line: "127.0.1.1 {{ host_hostname }} {{ _host_short }}"
    owner: root
    group: root
    mode: '0644'
